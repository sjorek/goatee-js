// Generated by CoffeeScript 1.6.3
/*
Â© Copyright 2013 Stephan Jorek <stephan.jorek@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied. See the License for the specific language governing
permissions and limitations under the License.
*/


(function() {
  var Expression, Stack, global, root, _, _ref, _ref1,
    __slice = [].slice;

  global = (function() {
    return this;
  })();

  _ = (_ref = global._) != null ? _ref : require('underscore');

  Stack = require('./Stack').Stack;

  root = (_ref1 = typeof module !== "undefined" && module !== null ? module.exports : void 0) != null ? _ref1 : this;

  root.Expression = (global.goatee != null ? global.goatee : global.goatee = {}).Expression = Expression = (function() {
    var _booleanize, _errors, _evaluate, _global, _isExpression, _isRightReference, _operations, _operator, _process, _scope, _stack, _stringify, _variables;

    _stack = void 0;

    _scope = null;

    _errors = null;

    _global = null;

    _variables = null;

    _operations = null;

    _isExpression = function(obj) {
      return _.isFunction(obj != null ? obj.evaluate : void 0);
    };

    _isRightReference = function() {
      var p;
      p = _stack.parent();
      return (p != null) && p.operator.name === '.' && p.parameters[1] === _stack.current();
    };

    Expression.evaluate = _evaluate = function(context, expression) {
      var e, isGlobalScope, result;
      if (context == null) {
        context = {};
      }
      if (!_isExpression(expression)) {
        return expression;
      }
      isGlobalScope = _stack === void 0;
      if (isGlobalScope) {
        _stack = new Stack(context);
        _scope = _stack.scope;
        _errors = null;
        _global = _stack.global;
        _variables = _stack.variables;
      }
      _stack.push(context, expression);
      try {
        result = _process(context, expression);
      } catch (_error) {
        e = _error;
        (_errors != null ? _errors : _errors = []).push(e);
      } finally {
        _stack.pop();
        if (isGlobalScope) {
          _stack.destructor();
          _stack = void 0;
          _scope = null;
          _global = null;
          _variables = null;
        }
      }
      if (_errors != null) {
        console.log('_errors', _errors);
      }
      return result;
    };

    _process = function(context, expression) {
      var left, leftValue, op, p, params, right, rightValue, value, values, _i, _len;
      op = expression.operator;
      params = expression.parameters;
      if (op.chain) {
        if (params.length !== 2) {
          throw new Error('chain only supports 2 parameters');
        }
        left = params[0];
        right = params[1];
        context = _evaluate(context, left);
        if (left.vector) {
          values = [];
          for (_i = 0, _len = context.length; _i < _len; _i++) {
            leftValue = context[_i];
            rightValue = _evaluate(leftValue, right);
            value = op.evaluate.call(leftValue, leftValue, rightValue);
            if (right.vector) {
              if (!Array.isArray(value)) {
                throw new Error('vector operation did not return an array as expected: ' + JSON.stringify(op));
              }
              values.push.apply(values, value);
            } else if (value != null) {
              values.push(value);
            }
          }
          return values;
        } else {
          return op.evaluate.call(context, context, _evaluate(context, right));
        }
      }
      if (op.evaluateParameters !== false) {
        values = (function() {
          var _j, _len1, _results;
          _results = [];
          for (_j = 0, _len1 = params.length; _j < _len1; _j++) {
            p = params[_j];
            _results.push(_evaluate(context, p));
          }
          return _results;
        })();
      } else {
        values = params;
      }
      return op.evaluate.apply(context, values);
    };

    Expression.booleanize = _booleanize = function(value) {
      var item, _i, _len;
      if (Array.isArray(value)) {
        for (_i = 0, _len = value.length; _i < _len; _i++) {
          item = value[_i];
          if (_booleanize(item)) {
            return true;
          }
        }
        return false;
      }
      return Boolean(value);
    };

    Expression.stringify = _stringify = function(value) {
      var format, operator, parameters;
      if (!_isExpression(value)) {
        return JSON.stringify(value);
      }
      operator = value.operator, parameters = value.parameters;
      format = operator.format;
      if (format != null) {
        return format.apply(this, parameters);
      } else if (parameters.length === 2) {
        return "(" + (_stringify(parameters[0])) + operator + (_stringify(parameters[1])) + ")";
      } else {
        return parameters.map(_stringify).join(' ');
      }
    };

    Expression.operations = _operations = {
      '=': {
        evaluate: function(a, b) {
          return _variables[a] = b;
        }
      },
      '-=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) - b;
        }
      },
      '+=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) + b;
        }
      },
      '*=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) * b;
        }
      },
      '/=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) / b;
        }
      },
      '%=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) % b;
        }
      },
      '^=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) ^ b;
        }
      },
      '>>>=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) >>> b;
        }
      },
      '>>=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) >> b;
        }
      },
      '<<=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) << b;
        }
      },
      '&=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) & b;
        }
      },
      '|=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) | b;
        }
      },
      '.': {
        chain: true,
        evaluate: function(a, b) {
          if (a !== _global && _.isFunction(b)) {
            return b.bind(a);
          } else {
            return b;
          }
        }
      },
      '+': {
        constant: true,
        evaluate: function(a, b) {
          return a + b;
        }
      },
      '-': {
        constant: true,
        evaluate: function(a, b) {
          return a - b;
        }
      },
      '*': {
        constant: true,
        evaluate: function(a, b) {
          return a * b;
        }
      },
      '!': {
        constant: true,
        evaluate: function(a) {
          return !a;
        }
      },
      '~': {
        constant: true,
        evaluate: function(a) {
          return ~a;
        }
      },
      '/': {
        constant: true,
        evaluate: function(a, b) {
          return a / b;
        }
      },
      '%': {
        constant: true,
        evaluate: function(a, b) {
          return a % b;
        }
      },
      '^': {
        constant: true,
        evaluate: function(a, b) {
          return a ^ b;
        }
      },
      '>>>': {
        constant: true,
        evaluate: function(a, b) {
          return a >>> b;
        }
      },
      '>>': {
        constant: true,
        evaluate: function(a, b) {
          return a >> b;
        }
      },
      '<<': {
        constant: true,
        evaluate: function(a, b) {
          return a << b;
        }
      },
      '&': {
        constant: true,
        evaluate: function(a, b) {
          return a & b;
        }
      },
      '|': {
        constant: true,
        evaluate: function(a, b) {
          return a | b;
        }
      },
      '&&': {
        evaluateParameters: false,
        constant: true,
        evaluate: function(a, b) {
          a = _evaluate(this, a);
          if (!a) {
            return a;
          }
          b = _evaluate(this, b);
          return b;
        }
      },
      '||': {
        evaluateParameters: false,
        constant: true,
        evaluate: function(a, b) {
          a = _evaluate(this, a);
          if (a) {
            return a;
          }
          b = _evaluate(this, b);
          return b;
        }
      },
      '<': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a < b;
        }
      },
      '>': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a > b;
        }
      },
      '<=': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a <= b;
        }
      },
      '>=': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a >= b;
        }
      },
      '==': {
        constant: true,
        vector: false,
        expandParameters: false,
        evaluate: function(a, b) {
          if (Array.isArray(a)) {
            return a.contains(b);
          }
          if (Array.isArray(b)) {
            return b.contains(a);
          }
          return a == b;
        }
      },
      '!=': {
        constant: true,
        vector: false,
        expandParameters: false,
        evaluate: function(a, b) {
          if (Array.isArray(a)) {
            return !a.contains(b);
          }
          if (Array.isArray(b)) {
            return !b.contains(a);
          }
          return a != b;
        }
      },
      '===': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a === b;
        }
      },
      '!==': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a !== b;
        }
      },
      '?:': {
        constant: true,
        evaluateParameters: false,
        vector: false,
        format: function(a, b, c) {
          return "(" + (_stringify(a)) + "?" + (_stringify(b)) + ":" + (_stringify(c)) + ")";
        },
        evaluate: function(a, b, c) {
          a = _evaluate(this, a);
          if (_booleanize(a)) {
            return _evaluate(this, b);
          } else {
            return _evaluate(this, c);
          }
        }
      },
      '()': {
        vector: false,
        format: function(func) {
          return func + '(' + Array.prototype.slice.call(arguments, 1).join(',') + ')';
        },
        evaluate: function(func) {
          if (func == null) {
            throw new Error("Missing reference to call.");
          }
          if (func.apply == null) {
            throw new Error("Reference is not callable.");
          }
          return func.apply(this, Array.prototype.slice.call(arguments, 1));
        }
      },
      '[]': {
        chain: false,
        vector: false,
        format: function(a, b) {
          return "" + a + "[" + b + "]";
        },
        evaluate: function(a, b) {
          var _ref2;
          if (_.isNumber(b) && b < 0) {
            b = ((_ref2 = a.length) != null ? _ref2 : 0) + b;
          }
          return a[b];
        }
      },
      '{}': {
        chain: true,
        vector: false,
        format: function(a, b) {
          return "" + a + "{" + b + "}";
        },
        evaluate: function(a, b) {
          if (_booleanize(b)) {
            return a;
          } else {
            return void 0;
          }
        }
      },
      context: {
        format: function(a) {
          return a;
        },
        vector: false,
        evaluate: function(a) {
          return {
            '$': _global,
            '@': _variables
          }[a];
        }
      },
      reference: {
        format: function(a) {
          return a;
        },
        vector: false,
        evaluate: function(a) {
          var context, index, ref, value;
          ref = _isRightReference();
          if (ref) {
            if (this.hasOwnProperty(a)) {
              value = this[a];
            }
          } else {
            if (_variables.hasOwnProperty(a)) {
              value = _variables[a];
            } else {
              value = this[a];
              index = _scope.length - 1;
              while (index >= 0) {
                context = _scope[index];
                if (context.hasOwnProperty(a)) {
                  value = context[a];
                  break;
                }
                index--;
              }
            }
          }
          return value;
        }
      },
      primitive: {
        constant: true,
        vector: false,
        format: function(a) {
          return JSON.stringify(a);
        },
        evaluate: function(a) {
          return a;
        }
      },
      block: {
        format: function() {
          var statements;
          statements = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
          return "{" + (statements.join(';')) + "}";
        },
        evaluate: function() {
          return arguments[arguments.length - 1];
        }
      },
      "if": {
        evaluateParameters: false,
        format: function(a, b, c) {
          if (c != null) {
            return "if (" + a + ") " + b + " else " + c;
          } else {
            return "if (" + a + ") " + b;
          }
        },
        evaluate: function(a, b, c) {
          a = _evaluate(this, a);
          if (_booleanize(a)) {
            return _evaluate(this, b);
          } else if (c != null) {
            return _evaluate(this, c);
          } else {
            return void 0;
          }
        }
      },
      array: {
        format: function() {
          var elements;
          elements = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
          return "[" + (elements.join(',')) + "]";
        },
        evaluate: function() {
          var elements;
          elements = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
          return elements;
        }
      },
      object: {
        format: function() {
          var buffer, i, l;
          buffer = [];
          i = 0;
          l = arguments.length;
          while (i < l) {
            buffer.push("" + arguments[i] + ":" + arguments[i + 1]);
            i += 2;
          }
          return "{" + (buffer.join(',')) + "}";
        },
        evaluate: function() {
          var i, l, object;
          object = {};
          i = 0;
          l = arguments.length;
          while (i < l) {
            object[arguments[i]] = arguments[i + 1];
            i += 2;
          }
          return object;
        }
      }
    };

    (function() {
      var key, value, _format;
      _format = _operations.reference.format;
      for (key in _operations) {
        value = _operations[key];
        value.name = key;
        value.toString = (function() {
          var k;
          k = key;
          return function() {
            return k;
          };
        })();
        value.toJSON = function() {
          return this.name;
        };
        if ((value.format == null) && key[key.length - 1] === "=") {
          value.format = (function() {
            var k;
            k = key;
            return function(a, b) {
              return "(" + (_format(a)) + k + (_stringify(b)) + ")";
            };
          })();
        }
      }
    })();

    Expression.operator = _operator = function(name) {
      var op;
      if ((op = _operations[name]) != null) {
        return op;
      }
      throw new Error("operation not found: " + name);
    };

    function Expression(op, params) {
      var param, _i, _j, _len, _len1;
      if (params == null) {
        params = [];
      }
      this.operator = _operator(op);
      this.parameters = params;
      this.constant = this.operator.constant === true;
      if (this.constant) {
        for (_i = 0, _len = params.length; _i < _len; _i++) {
          param = params[_i];
          if (_isExpression(param) && !param.constant) {
            this.constant = false;
            break;
          }
        }
      }
      this.vector = this.operator.vector;
      if (this.vector === void 0) {
        this.vector = false;
        for (_j = 0, _len1 = params.length; _j < _len1; _j++) {
          param = params[_j];
          if (_isExpression(param) && param.vector) {
            this.vector = true;
            break;
          }
        }
      }
      if (this.constant && this.operator.name !== 'primitive') {
        return new Expression('primitive', [this.evaluate(global)]);
      }
      return;
    }

    Expression.prototype.toString = function() {
      if (this.text !== void 0) {
        return this.text;
      }
      return this.text = _stringify(this);
    };

    Expression.prototype.toJSON = function() {
      return {
        op: this.operator.name,
        parameters: this.parameters
      };
    };

    Expression.prototype.evaluate = function(context) {
      return _evaluate(context, this);
    };

    return Expression;

  })();

}).call(this);

/*
//@ sourceMappingURL=Expression.map
*/
