// Generated by CoffeeScript 1.6.3
/*
Â© Copyright 2013 Stephan Jorek <stephan.jorek@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied. See the License for the specific language governing
permissions and limitations under the License.
*/


(function() {
  var Expression, global, root, _, _ref, _ref1;

  global = (function() {
    return this;
  })();

  _ = (_ref = global._) != null ? _ref : require('underscore');

  root = (_ref1 = typeof module !== "undefined" && module !== null ? module.exports : void 0) != null ? _ref1 : this;

  root.Expression = (global.goatee != null ? global.goatee : global.goatee = {}).Expression = Expression = (function() {
    var _booleanize, _current, _errors, _evaluate, _global, _isExpression, _isRightReference, _operations, _operator, _parent, _process, _scope, _stack, _stringify, _variables;

    _global = void 0;

    _variables = null;

    _errors = null;

    _stack = null;

    _scope = null;

    _current = function() {
      return _stack != null ? _stack[_stack.length - 1] : void 0;
    };

    _parent = function() {
      return _stack != null ? _stack[_stack.length - 2] : void 0;
    };

    _isExpression = function(obj) {
      return _.isFunction(obj != null ? obj.evaluate : void 0);
    };

    _isRightReference = function() {
      var p;
      p = _parent();
      return (p != null) && p.operator.name === '.' && p.parameters[1] === _current();
    };

    Expression.evaluate = _evaluate = function(context, expression) {
      var e, isGlobalScope, result;
      if (context == null) {
        context = {};
      }
      if (!_isExpression(expression)) {
        return expression;
      }
      isGlobalScope = _global === void 0;
      if (isGlobalScope) {
        _global = context;
        _errors = null;
        _variables = {};
        _stack = [];
        _scope = [];
      }
      _stack.push(expression);
      _scope.push(context);
      try {
        result = _process(context, expression);
      } catch (_error) {
        e = _error;
        (_errors != null ? _errors : _errors = []).push(e);
      } finally {
        if (isGlobalScope) {
          _global = void 0;
        }
        _stack.pop();
        _scope.pop();
      }
      return result;
    };

    _process = function(context, expression) {
      var left, leftValue, op, p, params, right, rightValue, value, values, _i, _len;
      op = expression.operator;
      params = expression.parameters;
      if (op.chain) {
        if (params.length !== 2) {
          throw new Error('chain only supports 2 parameters');
        }
        left = params[0];
        right = params[1];
        context = _evaluate(context, left);
        if (left.vector) {
          values = [];
          for (_i = 0, _len = context.length; _i < _len; _i++) {
            leftValue = context[_i];
            rightValue = _evaluate(leftValue, right);
            value = op.evaluate.call(leftValue, leftValue, rightValue);
            if (right.vector) {
              if (!Array.isArray(value)) {
                throw new Error('vector operation did not return an array as expected: ' + JSON.stringify(op));
              }
              values.push.apply(values, value);
            } else if (value != null) {
              values.push(value);
            }
          }
          return values;
        } else {
          return op.evaluate.call(context, context, e(context, right));
        }
      }
      if (op.evaluateParameters !== false) {
        values = (function() {
          var _j, _len1, _results;
          _results = [];
          for (_j = 0, _len1 = params.length; _j < _len1; _j++) {
            p = params[_j];
            _results.push(_evaluate(context, p));
          }
          return _results;
        })();
      } else {
        values = params;
      }
      return op.evaluate.apply(context, values);
    };

    Expression.operations = _operations = {
      '=': {
        evaluate: function(a, b) {
          return _variables[a] = b;
        }
      },
      '-=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) - b;
        }
      },
      '+=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) + b;
        }
      },
      '*=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) * b;
        }
      },
      '/=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) / b;
        }
      },
      '>>>=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) >>> b;
        }
      },
      '>>=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) >> b;
        }
      },
      '<<=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) << b;
        }
      },
      '&=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) & b;
        }
      },
      '^=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) ^ b;
        }
      },
      '|=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) | b;
        }
      },
      '%=': {
        evaluate: function(a, b) {
          return _variables[a] = _operations.reference.evaluate(a) % b;
        }
      },
      '.': {
        chain: true,
        evaluate: function(a, b) {
          if (a !== global && _.isFunction(b)) {
            return b.bind(a);
          } else {
            return b;
          }
        }
      },
      '+': {
        constant: true,
        evaluate: function(a, b) {
          return a + b;
        }
      },
      '-': {
        constant: true,
        evaluate: function(a, b) {
          return a - b;
        }
      },
      '*': {
        constant: true,
        evaluate: function(a, b) {
          return a * b;
        }
      },
      '!': {
        constant: true,
        evaluate: function(a) {
          return !a;
        }
      },
      '/': {
        constant: true,
        evaluate: function(a, b) {
          return a / b;
        }
      },
      '%': {
        constant: true,
        evaluate: function(a, b) {
          return a % b;
        }
      },
      '&&': {
        evaluateParameters: false,
        constant: true,
        evaluate: function(a, b) {
          a = _evaluate(this, a);
          if (!a) {
            return a;
          }
          b = _evaluate(this, b);
          return b;
        }
      },
      '||': {
        evaluateParameters: false,
        constant: true,
        evaluate: function(a, b) {
          a = _evaluate(this, a);
          if (a) {
            return a;
          }
          b = _evaluate(this, b);
          return b;
        }
      },
      '<': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a < b;
        }
      },
      '>': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a > b;
        }
      },
      '<=': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a <= b;
        }
      },
      '>=': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a >= b;
        }
      },
      '==': {
        constant: true,
        vector: false,
        expandParameters: false,
        evaluate: function(a, b) {
          if (Array.isArray(a)) {
            return a.contains(b);
          }
          if (Array.isArray(b)) {
            return b.contains(a);
          }
          return a == b;
        }
      },
      '!=': {
        constant: true,
        vector: false,
        expandParameters: false,
        evaluate: function(a, b) {
          if (Array.isArray(a)) {
            return !a.contains(b);
          }
          if (Array.isArray(b)) {
            return !b.contains(a);
          }
          return a != b;
        }
      },
      '===': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a === b;
        }
      },
      '!==': {
        constant: true,
        vector: false,
        evaluate: function(a, b) {
          return a !== b;
        }
      },
      '?:': {
        constant: true,
        evaluateParameters: false,
        vector: false,
        evaluate: function(a, b, c) {
          a = _evaluate(this, a);
          if (toBoolean(a)) {
            return _evaluate(this, b);
          } else {
            return _evaluate(this, c);
          }
        }
      },
      '()': {
        vector: false,
        format: function(func) {
          return func + '(' + Array.prototype.slice.call(arguments, 1).join(',') + ')';
        },
        evaluate: function(func) {
          return func != null ? func.apply(this, Array.prototype.slice.call(arguments, 1)) : void 0;
        }
      },
      '[]': {
        chain: false,
        vector: false,
        format: function(a, b) {
          return "" + a + "[" + b + "]";
        },
        evaluate: function(a, b) {
          var _ref2;
          if (_.isNumber(b) && b < 0) {
            b = ((_ref2 = a.length) != null ? _ref2 : 0) + b;
          }
          return a[b];
        }
      },
      '{}': {
        chain: true,
        vector: false,
        format: function(a, b) {
          return "" + a + "{" + b + "}";
        },
        evaluate: function(a, b) {
          if (toBoolean(b)) {
            return a;
          } else {
            return void 0;
          }
        }
      },
      context: {
        format: function(a) {
          return a;
        },
        vector: false,
        evaluate: function(a) {
          return {
            '$': _global,
            '@': this
          }[a];
        }
      },
      reference: {
        format: function(a) {
          return a;
        },
        vector: false,
        evaluate: function(a) {
          var context, index, value;
          if (_isRightReference()) {
            if (this.hasOwnProperty(a)) {
              value = this[a];
            }
          } else {
            if (_variables.hasOwnProperty(a)) {
              value = _variables[a];
            } else {
              value = this[a];
              index = _scope.length - 1;
              while (index >= 0) {
                context = _scope[index];
                if (context.hasOwnProperty(a)) {
                  value = context[a];
                  break;
                }
                index--;
              }
            }
          }
          return value;
        }
      },
      primitive: {
        constant: true,
        vector: false,
        format: function(a) {
          return JSON.stringify(a);
        },
        evaluate: function(a) {
          return a;
        }
      },
      block: {
        format: function() {
          var arg, b, _i, _len;
          b = ['{ '];
          for (_i = 0, _len = arguments.length; _i < _len; _i++) {
            arg = arguments[_i];
            b.push(arg.toString(), '; ');
          }
          b.push('}');
          return b.join('');
        },
        evaluate: function() {
          return arguments[arguments.length - 1];
        }
      },
      "if": {
        evaluateParameters: false,
        format: function(a, b, c) {
          if (c != null) {
            return "if (" + a + ") " + b + " else " + c;
          } else {
            return "if (" + a + ") " + b;
          }
        },
        evaluate: function(a, b, c) {
          a = _evaluate(this, a);
          if (toBoolean(a)) {
            return _evaluate(this, b);
          } else if (c != null) {
            return _evaluate(this, c);
          } else {
            return void 0;
          }
        }
      },
      "for": {
        evaluateParameters: false,
        format: function(a, b) {
          return "for (" + a + ") { " + b + " }";
        },
        evaluate: function(a, b) {
          var value, _i, _len, _ref2, _results;
          a = _evaluate(this, a);
          if (a == null) {
            return void 0;
          }
          _ref2 = _.values(a);
          _results = [];
          for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
            value = _ref2[_i];
            _results.push(_evaluate(value, b));
          }
          return _results;
        }
      },
      array: {
        format: function() {
          var arg;
          return "[" + (((function() {
            var _i, _len, _results;
            _results = [];
            for (_i = 0, _len = arguments.length; _i < _len; _i++) {
              arg = arguments[_i];
              _results.push(arg);
            }
            return _results;
          }).apply(this, arguments)).join(',')) + "]";
        },
        evaluate: function() {
          var arg, _i, _len, _results;
          _results = [];
          for (_i = 0, _len = arguments.length; _i < _len; _i++) {
            arg = arguments[_i];
            _results.push(arg);
          }
          return _results;
        }
      },
      object: {
        format: function() {
          var buffer, i;
          buffer = [];
          buffer.push('{');
          i = 0;
          while (i < arguments.length) {
            if (i > 0) {
              buffer.push(',');
            }
            buffer.push(arguments[i]);
            buffer.push(':');
            buffer.push(arguments[i + 1]);
            i += 2;
          }
          buffer.push('}');
          return buffer.join('');
        },
        evaluate: function() {
          var i, object;
          object = {};
          i = 0;
          while (i < arguments.length) {
            object[arguments[i]] = arguments[i + 1];
            i += 2;
          }
          return object;
        }
      }
    };

    (function() {
      var key, value;
      for (key in _operations) {
        value = _operations[key];
        value.name = key;
        value.toString = (function() {
          var k;
          k = key;
          return function() {
            return k;
          };
        })();
        value.toJSON = function() {
          return this.name;
        };
      }
    })();

    Expression.operator = _operator = function(name) {
      var op;
      if ((op = _operations[name]) != null) {
        return op;
      }
      throw new Error("operation not found: " + name);
    };

    Expression.booleanize = _booleanize = function(value) {
      var item, _i, _len;
      if (Array.isArray(value)) {
        for (_i = 0, _len = value.length; _i < _len; _i++) {
          item = value[_i];
          if (toBoolean(item)) {
            return true;
          }
        }
        return false;
      }
      return Boolean(value);
    };

    Expression.stringify = _stringify = function(value) {
      var format;
      if (!_isExpression(value)) {
        return JSON.stringify(value);
      }
      format = value.operator.format;
      if (format != null) {
        return format.apply(this, value.parameters);
      } else if (value.parameters.length === 2) {
        return '(' + _stringify(value.parameters[0]) + value.operator + _stringify(value.parameters[1]) + ')';
      } else {
        return value.parameters.map(_stringfy).join(' ');
      }
    };

    function Expression(op, params) {
      var param, _i, _j, _len, _len1;
      if (params == null) {
        params = [];
      }
      this.operator = _operator(op);
      this.parameters = params;
      this.constant = this.operator.constant === true;
      if (this.constant) {
        for (_i = 0, _len = params.length; _i < _len; _i++) {
          param = params[_i];
          if (_isExpression(param) && !param.constant) {
            this.constant = false;
            break;
          }
        }
      }
      this.vector = this.operator.vector;
      if (this.vector === void 0) {
        this.vector = false;
        for (_j = 0, _len1 = params.length; _j < _len1; _j++) {
          param = params[_j];
          if (_isExpression(param) && param.vector) {
            this.vector = true;
            break;
          }
        }
      }
      if (this.constant && this.operator.name !== 'primitive') {
        return new Expression('primitive', [this.evaluate(global)]);
      }
      return;
    }

    Expression.prototype.toString = function() {
      if (this.text !== void 0) {
        return this.text;
      }
      return this.text = _stringify(this);
    };

    Expression.prototype.toJSON = function() {
      return {
        op: this.operator.name,
        parameters: this.parameters
      };
    };

    Expression.prototype.evaluate = function(context) {
      return _evaluate(context, this);
    };

    return Expression;

  })();

}).call(this);

/*
//@ sourceMappingURL=Expression.map
*/
